<div id="alert-log">
  <table style="width:100%; text-align:left; border-collapse: collapse;">
    <thead>
      <tr style="border-bottom: 1px solid #333;">
        <th>Par</th>
        <th>Origem</th>
        <th>Variação</th>
        <th>Intervalo</th>
        <th>Preço Antigo</th>
        <th>Preço Atual</th>
        <th>Horário</th>
      </tr>
    </thead>
    <tbody id="alert-table-body"></tbody>
  </table>
</div>

function updateTable(symbol, origin, price) {
  const table = document.getElementById("crypto-table");
  const key = `${origin}_${symbol}`;
  const now = Date.now();

  if (!priceHistory[key]) {
    priceHistory[key] = [];
  }
  priceHistory[key].push({ time: now, price });
  priceHistory[key] = priceHistory[key].filter(p => now - p.time <= 15 * 60000);

  const rowId = `row-${key}`;
  let row = document.getElementById(rowId);
  const isNew = !row;

  if (isNew) {
    row = document.createElement("tr");
    row.id = rowId;
    row.innerHTML = `
      <td>${symbol}</td>
      <td>${origin}</td>
      <td class="price"></td>
      <td class="change-1"></td>
      <td class="change-3"></td>
      <td class="change-5"></td>
      <td class="change-15"></td>
      <td><a href="${origin === 'Binance' ? `https://www.binance.com/en/trade/${symbol}` : `https://www.mexc.com/exchange/${symbol}`}" target="_blank">Ver</a></td>
    `;
    table.appendChild(row);
  }
  row.querySelector(".price").textContent = price.toFixed(6);

  let hasPumpDump = false;

  if (!window.lastLoggedDiffs) {
    window.lastLoggedDiffs = {};
  }
  if (!window.lastAlertTimes) {
    window.lastAlertTimes = {};
  }

  intervals.forEach(min => {
    const past = priceHistory[key].reduce((oldest, p) => {
      return now - p.time >= min * 60000 && (!oldest || p.time < oldest.time) ? p : oldest;
    }, null);

    const cell = row.querySelector(`.change-${min}`);
    if (past) {
      const diff = ((price - past.price) / past.price) * 100;
      cell.textContent = `${diff > 0 ? "+" : ""}${diff.toFixed(2)}%`;
      const classType = diff > 2 ? "pump" : diff < -2 ? "dump" : "";
      cell.className = `change-${min} ${classType}`;

      const logKey = `${key}_${min}`;
      const lastLogged = window.lastLoggedDiffs[logKey] || 0;
      const lastAlertTime = window.lastAlertTimes[logKey] || 0;

      if (
        Math.abs(diff) > 2 &&
        Math.abs(diff - lastLogged) >= 1 &&
        now - lastAlertTime >= 180000 // 3 minutos
      ) {
        hasPumpDump = true;
        window.lastLoggedDiffs[logKey] = diff;
        window.lastAlertTimes[logKey] = now;
        playSingleBeep(symbol);
        logSignal(symbol, origin, diff, min, past.price, price);
      }
    } else {
      cell.textContent = "...";
      cell.className = `change-${min}`;
    }
  });

  if (hasPumpDump && table.firstChild !== row) {
    table.insertBefore(row, table.firstChild);
  }
}

function logSignal(symbol, origin, percent, min, oldPrice, currentPrice) {
  const timestamp = new Date().toLocaleTimeString();
  const alertTable = document.getElementById("alert-table-body");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${symbol}</td>
    <td>${origin}</td>
    <td>${percent.toFixed(2)}%</td>
    <td>${min} min</td>
    <td>${oldPrice.toFixed(6)}</td>
    <td>${currentPrice.toFixed(6)}</td>
    <td>${timestamp}</td>
  `;
  alertTable.prepend(tr);
  while (alertTable.children.length > 100) alertTable.removeChild(alertTable.lastChild);
}
